#!/usr/bin/env ruby

require "dante"
require "gorthaur"

DEFAULT_RATE = 5
DEFAULT_FRAME = 1
DEFAULT_PATH = File.join(Dir.home, "Pictures", "gorthaur", "frames")
DEFAULT_PID_PATH = File.join(Dir.home, ".gorthaur")
DEFAULT_LOG_PATH = File.join(Dir.home, ".gorthaur")

case
when ARGV.include?("listener") then
  Dante::Runner.new("gorthaur_listener").tap do |runner|
    runner.description = "Listen for any watchers"
    
    log_path = File.join((ENV["GORTHAUR_LOG_PATH"] || DEFAULT_LOG_PATH), "listener.log")
    pid_path = File.join((ENV["GORTHAUR_PID_PATH"] || DEFAULT_PID_PATH), "listener.pid")
    
    runner.execute(:log_path => log_path, :pid_path => pid_path) do
      server = Gorthaur::Server.new
      Thread.new { server.call }
      DRb.start_service(Gorthaur::URI, server)
      DRb.thread.join
    end
  end

when ARGV.include?("watcher")
  Dante::Runner.new("gorthaur_watcher").tap do |runner|
    runner.description = "Watches and reports to the listener"

    runner.with_options do |opts|
      opts.on("-r", "--rate SECONDS", Integer, "Wait this long between shots") do |rate|
        options[:rate] = rate
      end

      opts.on("-f", "--frame INDEX", Integer, "Start at this frame index") do |frame|
        options[:frame] = frame
      end

      opts.on("-p", "--path PATH", String, "Store shots in this path") do |path|
        options[:path] = path
      end
    end
    
    log_path = File.join((ENV["GORTHAUR_LOG_PATH"] || DEFAULT_LOG_PATH), "watcher.log")
    pid_path = File.join((ENV["GORTHAUR_PID_PATH"] || DEFAULT_PID_PATH), "watcher.pid")

    runner.execute(:log_path => log_path, :pid_path => pid_path) do |opts|
      rate = opts[:rate] || ENV["GORTHAUR_RATE"] || DEFAULT_RATE
      frame = opts[:frame] || ENV["GORTHAUR_FRAME"] || DEFAULT_FRAME
      directory = opts[:path] || ENV["GORTHAUR_PATH"] || DEFAULT_PATH

      Gorthaur::Client.new(rate, frame, FileUtils.mkdir_p(directory).first).call
    end
  end

end
